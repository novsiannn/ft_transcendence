<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .events { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: auto; font-family: monospace; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .button-group { margin-top: 10px; }
        .button-group button { padding: 8px 12px; margin-right: 5px; cursor: pointer; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
        .debug { color: #888; }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebSocket Test</h1>
        
        <div class="section">
            <h2>Token Validation</h2>
            <div class="form-group">
                <label for="token">JWT Token:</label>
                <input type="text" id="token" placeholder="Paste your JWT token here">
            </div>
            <div class="button-group">
                <button id="validateToken">Validate Token</button>
            </div>
            <div id="tokenResult" style="margin-top: 10px;"></div>
        </div>
        
        <div class="section">
            <h2>WebSocket Connection Settings</h2>
            <div class="form-group">
                <label for="socketUrl">WebSocket URL:</label>
                <input type="text" id="socketUrl" value="https://localhost:3000" placeholder="WebSocket URL">
            </div>
            <div class="button-group">
                <button id="connect">Connect</button>
                <button id="disconnect" disabled>Disconnect</button>
                <button id="sendTest" disabled>Send Test Message</button>
                <button id="checkStatus" disabled>Check Status</button>
            </div>
            <div id="connectionStatus" style="margin-top: 10px;"></div>
        </div>
        
        <div class="section">
            <h2>Events:</h2>
            <div id="events" class="events"></div>
            <div class="button-group" style="margin-top: 10px;">
                <button id="clearEvents">Clear Events</button>
            </div>
        </div>
    </div>
    
    <script>
        let socket = null;
        let connectTimeout = null;
        
        const tokenInput = document.getElementById('token');
        const socketUrlInput = document.getElementById('socketUrl');
        const validateTokenBtn = document.getElementById('validateToken');
        const tokenResultDiv = document.getElementById('tokenResult');
        const connectBtn = document.getElementById('connect');
        const disconnectBtn = document.getElementById('disconnect');
        const sendTestBtn = document.getElementById('sendTest');
        const checkStatusBtn = document.getElementById('checkStatus');
        const eventsDiv = document.getElementById('events');
        const clearEventsBtn = document.getElementById('clearEvents');
        const connectionStatusDiv = document.getElementById('connectionStatus');
        
        function logEvent(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const eventElement = document.createElement('div');
            eventElement.style.marginBottom = '5px';
            
            switch(type) {
                case 'error':
                    eventElement.className = 'error';
                    break;
                case 'success':
                    eventElement.className = 'success';
                    break;
                case 'warning':
                    eventElement.className = 'warning';
                    break;
                case 'debug':
                    eventElement.className = 'debug';
                    break;
            }
            
            eventElement.textContent = `${timestamp}: ${message}`;
            eventsDiv.appendChild(eventElement);
            eventsDiv.scrollTop = eventsDiv.scrollHeight;
        }
        
        function updateConnectionStatus() {
            if (!socket) {
                connectionStatusDiv.innerHTML = '<span class="error">Not connected</span>';
                return;
            }
            
            switch(socket.connected) {
                case true:
                    connectionStatusDiv.innerHTML = '<span class="success">Connected</span>';
                    break;
                case false:
                    connectionStatusDiv.innerHTML = '<span class="error">Disconnected</span>';
                    break;
            }
        }
        
        validateTokenBtn.addEventListener('click', async function() {
            const token = tokenInput.value.trim();
            if (!token) {
                tokenResultDiv.innerHTML = '<span class="error">Please enter a token</span>';
                return;
            }
            
            try {
                logEvent('Validating token with server...', 'debug');
                const response = await fetch('https://localhost:3000/api/test-token', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.isValid) {
                    tokenResultDiv.innerHTML = '<span class="success">Token is valid!</span> <pre>' + 
                        JSON.stringify(data.userData, null, 2) + '</pre>';
                    logEvent('Token validated successfully', 'success');
                } else {
                    tokenResultDiv.innerHTML = '<span class="error">Token is invalid!</span>';
                    logEvent('Token validation failed', 'error');
                }
            } catch (error) {
                tokenResultDiv.innerHTML = '<span class="error">Error checking token: ' + error.message + '</span>';
                logEvent('Error validating token: ' + error.message, 'error');
            }
        });
        
        connectBtn.addEventListener('click', function() {
            const token = tokenInput.value.trim();
            const socketUrl = socketUrlInput.value.trim();
            
            if (!token) {
                logEvent('Please enter a token', 'error');
                return;
            }
            
            if (!socketUrl) {
                logEvent('Please enter a WebSocket URL', 'error');
                return;
            }
            
            logEvent('Attempting to connect to ' + socketUrl + '...', 'debug');
            
            if (socket) {
                socket.disconnect();
            }
            
            socket = io(socketUrl, {
                auth: { token },
                withCredentials: true,
                transports: ['websocket'],
                rejectUnauthorized: false,
                secure: true,
                reconnection: true,
                reconnectionAttempts: 5,
                reconnectionDelay: 1000
            });
            
            socket.on('connect_error', function(error) {
                logEvent('Connection error: ' + error.message, 'error');
                updateConnectionStatus();
            });
            
            socket.on('connect_timeout', function() {
                logEvent('Connection timeout', 'error');
                updateConnectionStatus();
            });
            
            socket.on('error', function(error) {
                logEvent('Socket error: ' + (typeof error === 'object' ? JSON.stringify(error) : error), 'error');
                updateConnectionStatus();
            });
            
            socket.on('connect', function() {
                logEvent('Connected to server with socket ID: ' + socket.id, 'success');
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                sendTestBtn.disabled = false;
                checkStatusBtn.disabled = false;
                
                if (connectTimeout) {
                    clearTimeout(connectTimeout);
                    connectTimeout = null;
                }
                
                updateConnectionStatus();
            });
            
            socket.on('disconnect', function(reason) {
                logEvent('Disconnected: ' + reason, 'warning');
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                sendTestBtn.disabled = true;
                checkStatusBtn.disabled = true;
                updateConnectionStatus();
            });
            
            socket.on('reconnect', function(attemptNumber) {
                logEvent('Reconnected after ' + attemptNumber + ' attempts', 'success');
                updateConnectionStatus();
            });
            
            socket.on('reconnect_attempt', function(attemptNumber) {
                logEvent('Reconnection attempt #' + attemptNumber, 'debug');
            });
            
            socket.on('reconnect_error', function(error) {
                logEvent('Reconnection error: ' + error.message, 'error');
            });
            
            socket.on('reconnect_failed', function() {
                logEvent('Failed to reconnect', 'error');
            });
            
            socket.on('welcome', function(data) {
                logEvent('Welcome message: ' + data.message, 'success');
            });
            
            socket.on('test_response', function(data) {
                logEvent('Received test response: ' + JSON.stringify(data), 'success');
            });
            
            connectTimeout = setTimeout(function() {
                if (socket && !socket.connected) {
                    logEvent('Connection attempt timed out after 10 seconds', 'error');
                }
            }, 10000);
        });
        
        disconnectBtn.addEventListener('click', function() {
            if (socket) {
                logEvent('Manually disconnecting...', 'debug');
                socket.disconnect();
            }
        });
        
        sendTestBtn.addEventListener('click', function() {
            if (socket && socket.connected) {
                const testMessage = { message: 'Hello from browser!', timestamp: new Date().toISOString() };
                logEvent('Sending test message: ' + JSON.stringify(testMessage), 'debug');
                socket.emit('test', testMessage);
            } else {
                logEvent('Cannot send message: Not connected', 'error');
            }
        });
        
        checkStatusBtn.addEventListener('click', function() {
            if (socket) {
                logEvent('Socket status: ' + (socket.connected ? 'Connected' : 'Disconnected'), 'debug');
                logEvent('Socket ID: ' + (socket.id || 'none'), 'debug');
                updateConnectionStatus();
            } else {
                logEvent('Socket object does not exist', 'error');
                updateConnectionStatus();
            }
        });
        
        clearEventsBtn.addEventListener('click', function() {
            eventsDiv.innerHTML = '';
            logEvent('Event log cleared', 'debug');
        });
        
        updateConnectionStatus();
    </script>
</body>
</html>